# Коннектор к Финам Common Trade APi C#
Собран на основе https://github.com/VozyakovAV/OrderBookScreener
По всем вопросам пишите в общий чат телеграм https://t.me/moexdma
Внутри лежит готовый пример FinamExample c логами, кнопкой отправки заявки. 

# Возможности коннектора
- отправлять обычные заявки (упрощение, не нужно добавлять коды к инструментам и т.д.)
- отправлять стоп заявки (упрощение)
- Добавлено рабочее время сервера финам. Коннектор спокойно переносит ночное время, выходные. 
- Добавлены запросы по свечкам (получать историю)
- Автоматическое обновление портфелей и стоп заявок по таймеру (сокетов на это нет)
- Повторное выставление стоп заявок (до 10 раз). Сделано так как вы можете нарушить лимиты и по этой причине стоп не будет выставлен. 
- Множественные коды счетов. Тут же адаптация по позициям, поскольку будет по несколько позициям)
- Коннектор по умолчанию упрощает работу с отправкой заявок - сам находит коды инструментов.

# Нюансы 

У финам немного странные лимиты. 1 раз в минуту на получение инструментов. 
Загрузка инструментов в начале подключения является базовой настройкой, потому что инструменты и их коды потом используются везде. 

# Первоначальные инструкции

Вам понадобится ключ к торговле у CommonTradeAPi https://www.comon.ru/my/trade-api/tokens/
И обязательно узнать коды счетов клиента, которые вы будете использовать. Далее, вписать их в код для торговли. 

По умолчанию коннектор грузит только следующие инструменты  Market.Stock / Market.Forts / Market.Spbex
99% нужны только эти инструменты, а коды инструментов могут часто пересекаться, что крайне сильно усложняет работу для отправки обычных заявок. 

Конкретно в этом коннекторе отсутсвует 
- подписка на заявки сделки, на биржевой стакан (нужна более плотная адаптация) Чуть позже мы все это добавим. 
- Это пробный вариант. Мы проверяем насколько нужно людям вообще публикация таких коннекторов. Данный коннектор в боевом режиме используется 24/7
в основном для выставления стоп заявок. 

# Подключение и подписка на базовые события 

```cs
 _config = new Config()
{
    //Ключ не бесконечный, работает какое то время.. 
    Token = "****************",
    //Работаем со множественными кодами, код вы можете получить у Common Trade API
    ClientIds = new List<string>()
    {
        {"408868****"}, //заменить на свой!
    },
};

 _connector = new FinamConnector.Connectors.FinamConnector(_config)
 {
     //каждые 3 секунды обновляем стопы
     StopTimer = 3000,
     //каждые 5 секунд обновляем позиции
     PortfolioTimer = 5000,
 };

 _connector.UpdatedPositions += (positions, clientID) =>
 {
     //обновление по позициям. 
     foreach(var pos in positions)
     {
         decimal currentprice = (decimal)pos.Value.CurrentPrice ;
         Debug.WriteLine($" {pos.Value.Symbol} Поза {pos.Value.Balance} clientID ={pos.Value.ClientID} Цена {pos.Value.CurrentPrice}");
     }
 };

 _connector.Error += error =>
 {
     LogMessage($"Error (ошибка)-> {error.Message}");
 };
 _connector.NewCriticalError += (message) =>
 {
     LogMessage(message);
 };
 _connector.NewLogMessage += LogMessage;

 _connector.Connect();
```

# Отправка ордера 

Если были допущены ошибки. Придет res = null и ошибка от коннектора прилетит в лог. 

```cs

    //Клиент ID можно взять из конфига... тут прописан просто напрямик
    var res = await _connector.SendOrderAsync("408868*****", "SNGS", Finam.TradeApi.Proto.V1.BuySell.Buy, 1,30);

    if (res != null)
    {
        LogMessage($"Результат выставление заявки {res.TransactionId}");
    }
```


# Дополнительно

Получение свечек. 
```cs
  _connector.GetCandles("SNGS", FinamConnector.Connectors.CandleInterval.H1)
```
Отправка стоп ордеров 
```cs
 _connector.PlaceStopOrder(.....)
```
Забрать из списка активные стоп ордера (обновляются и ведутся сами)
```cs
 var activestops = _connector.ActiveStops;
```


